#!/bin/sh

if [ -n "`echo "$0" | grep 'dev$'`" ]; then
    mode=dev
else
    mode=run
fi

if [ \( ! -f okami \) -o $mode = dev ]; then
    echo -n rebuilding...
    as=`which arm-linux-gnueabihf-as`
    ld=`which arm-linux-gnueabihf-ld`
    if [ -z "$as" ]; then
        as=as
        ld=ld
    fi
    ($as okami.s -o okami.o && $ld okami.o -o okami) \
        || (echo \ failed; exit 1)
    echo \ ok
fi

if [ $mode = dev ]; then
    basefiles='
      lib/core.ok
      lib/hex.ok
      lib/os/io.ok
      lib/os/tty.ok
      lib/dev/debug.ok
   '
else
  basefiles='lib/core.ok'
fi

if [ -z "$1" ]; then
    runfile=/dev/null
else
    if [ -d "$1" ]; then
        runfile="$1"/Runfile
    else
        runfile="$1"
    fi
fi

if [ ! \( -e "$runfile" -a ! -d "$runfile" \) ]; then
    echo "Runfile invalid: $runfile"
    exit 1
fi

rlwrap=`which rlwrap`
$rlwrap ./okami $basefiles `cat "$runfile" | sed -e 's/#.*$//g'`
